<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spellbook - Mission Control</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- xterm.js for terminal emulation -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.min.js"></script>
  <link rel="stylesheet" href="styles.css">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            spellbook: {
              bg: '#0a0a0f',
              card: '#14141f',
              border: '#1f1f2e',
              accent: '#00ff88',
              text: '#e0e0e0',
              muted: '#666680',
            }
          },
          fontFamily: {
            mono: ['Space Mono', 'Menlo', 'Monaco', 'monospace'],
          }
        }
      }
    }
  </script>
</head>
<body class="dark bg-spellbook-bg text-spellbook-text font-mono min-h-screen">
  <div id="app" class="flex h-screen">

    <!-- LEFT SIDEBAR (Icons Only) -->
    <aside class="w-[60px] border-r border-spellbook-border flex flex-col items-center py-3 bg-spellbook-card shrink-0">
      <!-- Navigation Icons -->
      <nav class="flex flex-col gap-1 flex-1">
        <button onclick="switchMainView('dashboard')" id="nav-dashboard" class="sidebar-nav-btn group relative w-10 h-10 flex items-center justify-center rounded-lg hover:bg-spellbook-accent/20 transition-colors" title="Dashboard">
          <svg class="w-5 h-5 text-spellbook-muted group-hover:text-spellbook-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
          </svg>
          <span class="sidebar-tooltip">Dashboard</span>
        </button>
        <button onclick="switchMainView('kanban')" id="nav-kanban" class="sidebar-nav-btn group relative w-10 h-10 flex items-center justify-center rounded-lg bg-spellbook-accent/20 transition-colors" title="Kanban">
          <svg class="w-5 h-5 text-spellbook-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/>
          </svg>
          <span class="sidebar-tooltip">Kanban</span>
        </button>
        <button onclick="switchMainView('inbox')" id="nav-inbox" class="sidebar-nav-btn group relative w-10 h-10 flex items-center justify-center rounded-lg hover:bg-spellbook-accent/20 transition-colors" title="Inbox">
          <svg class="w-5 h-5 text-spellbook-muted group-hover:text-spellbook-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
          </svg>
          <span id="nav-inbox-badge" class="absolute -top-1 -right-1 min-w-[18px] h-[18px] flex items-center justify-center bg-yellow-500 text-black text-[10px] font-bold rounded-full hidden">0</span>
          <span class="sidebar-tooltip">Inbox</span>
        </button>
        <button onclick="switchMainView('investigate')" id="nav-investigate" class="sidebar-nav-btn group relative w-10 h-10 flex items-center justify-center rounded-lg hover:bg-spellbook-accent/20 transition-colors" title="Investigate">
          <svg class="w-5 h-5 text-spellbook-muted group-hover:text-spellbook-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <span class="sidebar-tooltip">Investigate</span>
        </button>
        <button onclick="switchMainView('terminals')" id="nav-terminals" class="sidebar-nav-btn group relative w-10 h-10 flex items-center justify-center rounded-lg hover:bg-spellbook-accent/20 transition-colors" title="Terminal Manager">
          <svg class="w-5 h-5 text-spellbook-muted group-hover:text-spellbook-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          <span class="sidebar-tooltip">Terminals</span>
        </button>
        <button onclick="switchMainView('knowledge')" id="nav-knowledge" class="sidebar-nav-btn group relative w-10 h-10 flex items-center justify-center rounded-lg hover:bg-spellbook-accent/20 transition-colors" title="Knowledge Base">
          <svg class="w-5 h-5 text-spellbook-muted group-hover:text-spellbook-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
          </svg>
          <span class="sidebar-tooltip">Knowledge Base</span>
        </button>
        <button onclick="switchMainView('worktrees')" id="nav-worktrees" class="sidebar-nav-btn group relative w-10 h-10 flex items-center justify-center rounded-lg hover:bg-spellbook-accent/20 transition-colors" title="Worktrees">
          <svg class="w-5 h-5 text-spellbook-muted group-hover:text-spellbook-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 3v12"/>
            <circle cx="6" cy="18" r="3" stroke-width="2"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 6c6 0 6 6 12 6"/>
            <circle cx="18" cy="12" r="3" stroke-width="2"/>
          </svg>
          <span class="sidebar-tooltip">Worktrees</span>
        </button>
      </nav>
    </aside>

    <!-- MAIN CONTENT WRAPPER -->
    <div class="flex-1 flex flex-col overflow-hidden">

      <!-- TOP HEADER (Simplified) -->
      <header class="border-b border-spellbook-border px-4 py-2 flex items-center justify-between shrink-0">
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2">
            <svg class="w-6 h-6" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
              <path d="M420 80 H 130 C 100 80 100 80 100 110 V 460 C 100 480 120 480 130 480 H 430 C 450 480 450 460 450 450 V 110 C 450 90 440 80 420 80 Z" fill="#F5E1C8" stroke="#333" stroke-width="5"/>
              <path d="M430 450 H 130" stroke="#D4C0A8" stroke-width="4"/>
              <path d="M430 460 H 130" stroke="#D4C0A8" stroke-width="4"/>
              <rect x="80" y="50" width="340" height="400" rx="10" ry="10" fill="#4B0082" stroke="#2E0050" stroke-width="5"/>
              <rect x="80" y="50" width="60" height="400" rx="10" ry="10" fill="#380061"/>
              <path d="M420 50 L 370 50 L 420 100 Z" fill="#FFD700"/>
              <path d="M420 450 L 370 450 L 420 400 Z" fill="#FFD700"/>
              <circle cx="250" cy="250" r="70" fill="none" stroke="#FFD700" stroke-width="15"/>
              <polygon points="250,195 265,240 310,240 275,265 285,310 250,285 215,310 225,265 190,240 235,240" fill="#FFD700"/>
              <rect x="160" y="350" width="180" height="10" rx="5" fill="#FFD700" opacity="0.6"/>
              <rect x="160" y="370" width="180" height="10" rx="5" fill="#FFD700" opacity="0.6"/>
            </svg>
            <h1 class="text-lg font-bold text-spellbook-accent">SPELLBOOK</h1>
          </div>
          <select id="project-selector" class="bg-spellbook-card border border-spellbook-border rounded px-3 py-1 text-sm">
            <option value="">Loading...</option>
          </select>
        </div>
        <div class="flex items-center gap-3">
          <!-- Branch Display -->
          <span id="branch-display" class="text-xs text-spellbook-muted px-2 py-1 bg-spellbook-card rounded">
            branch: loading...
          </span>

          <!-- Uncommitted Changes Indicator -->
          <div id="uncommitted-indicator" class="group relative flex items-center gap-1.5 px-2 py-1 bg-spellbook-card border border-spellbook-border rounded text-xs hidden">
            <span id="uncommitted-dot" class="w-2 h-2 rounded-full bg-yellow-500"></span>
            <span id="uncommitted-text" class="text-yellow-400">0 uncommitted</span>
            <!-- Tooltip with file list -->
            <div id="uncommitted-tooltip" class="absolute left-0 top-full mt-1 w-64 bg-spellbook-card border border-spellbook-border rounded shadow-lg p-2 hidden group-hover:block z-50 text-xs">
              <div class="font-semibold text-spellbook-muted mb-1">Uncommitted Files:</div>
              <div id="uncommitted-files" class="max-h-32 overflow-y-auto space-y-0.5 font-mono text-spellbook-text"></div>
            </div>
          </div>

          <!-- Git Sync Status (vs origin/develop) -->
          <div id="git-sync-indicator" class="flex items-center gap-1.5 px-2 py-1 bg-spellbook-card border border-spellbook-border rounded text-xs">
            <span class="text-spellbook-muted">origin:</span>
            <span id="git-sync-dot" class="w-2 h-2 rounded-full bg-gray-500" title="Checking..."></span>
            <span id="git-sync-status" class="text-spellbook-muted">...</span>
            <button id="git-sync-btn" onclick="pullFromOrigin()" class="px-2 py-0.5 bg-spellbook-accent/20 text-spellbook-accent rounded hover:bg-spellbook-accent/30 hidden" title="Pull from origin/develop">
              Pull
            </button>
          </div>

          <!-- Main Comparison Indicator -->
          <div id="main-comparison-indicator" class="group relative flex items-center gap-1.5 px-2 py-1 bg-spellbook-card border border-spellbook-border rounded text-xs">
            <span class="text-spellbook-muted">main:</span>
            <span id="main-comparison-dot" class="w-2 h-2 rounded-full bg-gray-500"></span>
            <span id="main-comparison-text" class="text-spellbook-muted">...</span>
            <!-- Tooltip with explanation -->
            <div class="absolute left-0 top-full mt-1 w-56 bg-spellbook-card border border-spellbook-border rounded shadow-lg p-2 hidden group-hover:block z-50 text-xs">
              <div id="main-comparison-tooltip" class="text-spellbook-text">Comparing develop to origin/main</div>
            </div>
          </div>

          <!-- Pull Main Button -->
          <button id="pull-main-btn" onclick="pullMainIntoDevelop()" class="flex items-center gap-1 px-2 py-1 bg-purple-500/20 text-purple-400 border border-purple-500/30 rounded text-xs hover:bg-purple-500/30 transition-colors" title="Pull origin/main into develop">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            <span id="pull-main-text">Pull Main</span>
          </button>

          <!-- Last Sync Time -->
          <span id="git-sync-time" class="text-spellbook-muted/50 text-[10px]" title="Last checked"></span>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="quickLog('bug')" class="px-3 py-1 bg-red-500/20 text-red-400 rounded text-sm hover:bg-red-500/30">
            + Bug
          </button>
          <button onclick="quickLog('improvement')" class="px-3 py-1 bg-blue-500/20 text-blue-400 rounded text-sm hover:bg-blue-500/30">
            + Improvement
          </button>
          <button onclick="quickLog('feature')" class="px-3 py-1 bg-purple-500/20 text-purple-400 rounded text-sm hover:bg-purple-500/30">
            + Feature
          </button>
          <button onclick="quickAddIdea()" class="px-3 py-1 bg-yellow-500/20 text-yellow-400 rounded text-sm hover:bg-yellow-500/30">
            + Idea
          </button>
        </div>
      </header>

      <!-- Main Content Area -->
      <main class="flex-1 flex flex-col overflow-hidden">

      <!-- DASHBOARD VIEW -->
      <div id="dashboard-view" class="flex-1 flex-col overflow-hidden hidden">
        <!-- Dashboard Header -->
        <div class="px-6 py-4 border-b border-spellbook-border">
          <div class="flex items-center justify-between">
            <div>
              <h2 id="dashboard-project-name" class="text-xl font-bold text-spellbook-accent">Project Dashboard</h2>
              <div id="dashboard-git-info" class="text-sm text-spellbook-muted mt-1">Loading...</div>
            </div>
            <div class="flex items-center gap-4">
              <button onclick="refreshDashboard()" class="px-3 py-1 bg-spellbook-card border border-spellbook-border rounded text-sm hover:border-spellbook-accent">
                ‚Üª Refresh
              </button>
              <span id="dashboard-updated" class="text-xs text-spellbook-muted"></span>
            </div>
          </div>
        </div>

        <div class="flex-1 flex overflow-hidden">
          <!-- Left: Stats & Info -->
          <div class="w-1/3 border-r border-spellbook-border overflow-y-auto p-4">
            <!-- Quick Stats -->
            <div class="mb-6">
              <h3 class="text-sm font-semibold text-spellbook-muted mb-3">PROJECT OVERVIEW</h3>
              <div class="grid grid-cols-2 gap-3">
                <div class="bg-spellbook-card border border-spellbook-border rounded-lg p-3">
                  <div id="stat-features" class="text-2xl font-bold text-spellbook-accent">-/-</div>
                  <div class="text-xs text-spellbook-muted">Features Complete</div>
                </div>
                <div class="bg-spellbook-card border border-spellbook-border rounded-lg p-3">
                  <div id="stat-bugs" class="text-2xl font-bold text-red-400">-</div>
                  <div class="text-xs text-spellbook-muted">Active Bugs</div>
                </div>
                <div class="bg-spellbook-card border border-spellbook-border rounded-lg p-3">
                  <div id="stat-improvements" class="text-2xl font-bold text-blue-400">-</div>
                  <div class="text-xs text-spellbook-muted">Improvements</div>
                </div>
                <div class="bg-spellbook-card border border-spellbook-border rounded-lg p-3">
                  <div id="stat-inbox" class="text-2xl font-bold text-purple-400">-</div>
                  <div class="text-xs text-spellbook-muted">Inbox Items</div>
                </div>
              </div>
            </div>

            <!-- Tech Stack -->
            <div class="mb-6">
              <h3 class="text-sm font-semibold text-spellbook-muted mb-3">TECH STACK</h3>
              <div id="tech-stack-list" class="bg-spellbook-card border border-spellbook-border rounded-lg p-3">
                <div class="text-spellbook-muted text-sm">Loading...</div>
              </div>
            </div>

            <!-- Project Path -->
            <div>
              <h3 class="text-sm font-semibold text-spellbook-muted mb-3">PROJECT PATH</h3>
              <div id="project-path" class="bg-spellbook-card border border-spellbook-border rounded-lg p-3 text-xs font-mono text-spellbook-muted break-all">
                Loading...
              </div>
            </div>
          </div>

          <!-- Right: Roadmap Content -->
          <div class="w-2/3 flex flex-col overflow-hidden">
            <div class="px-4 py-2 border-b border-spellbook-border flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-sm font-semibold">üìã ROADMAP</span>
                <span class="text-xs text-spellbook-muted">(auto-generated)</span>
              </div>
              <span id="roadmap-modified" class="text-xs text-spellbook-muted"></span>
            </div>
            <div id="roadmap-content" class="flex-1 overflow-auto p-4 prose prose-invert max-w-none">
              <div class="text-center text-spellbook-muted py-8">Loading roadmap...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- INVESTIGATE VIEW -->
      <div id="investigate-view" class="flex-1 flex-col overflow-hidden hidden">
        <!-- Investigation Header -->
        <div class="px-6 py-4 border-b border-spellbook-border">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-xl font-bold text-spellbook-accent">Investigate</h2>
              <div class="text-sm text-spellbook-muted mt-1">Research the codebase or hunt for bugs</div>
            </div>
            <div class="flex items-center gap-2">
              <button onclick="startNewInvestigation('research')" class="px-4 py-2 bg-blue-500/20 text-blue-400 rounded hover:bg-blue-500/30">
                üîç Codebase Research
              </button>
              <button onclick="startNewInvestigation('bug')" class="px-4 py-2 bg-red-500/20 text-red-400 rounded hover:bg-red-500/30">
                üêõ Bug Hunt
              </button>
            </div>
          </div>
        </div>

        <div class="flex-1 flex overflow-hidden">
          <!-- Left: Investigation Sessions -->
          <div class="w-1/3 border-r border-spellbook-border overflow-y-auto">
            <div class="p-4">
              <h3 class="text-sm font-semibold text-spellbook-muted mb-3">ACTIVE INVESTIGATIONS</h3>
              <div id="investigation-sessions" class="space-y-2">
                <div class="text-center text-spellbook-muted py-8 text-sm">
                  No active investigations. Start one above.
                </div>
              </div>
            </div>

            <!-- Quick Question -->
            <div class="p-4 border-t border-spellbook-border">
              <h3 class="text-sm font-semibold text-spellbook-muted mb-3">QUICK QUESTION</h3>
              <textarea id="quick-question-input" class="w-full bg-spellbook-card border border-spellbook-border rounded p-3 text-sm resize-none h-24 focus:border-spellbook-accent outline-none" placeholder="Ask a question about the codebase..."></textarea>
              <button onclick="askQuickQuestion()" class="mt-2 w-full px-4 py-2 bg-spellbook-accent/20 text-spellbook-accent rounded hover:bg-spellbook-accent/30 text-sm">
                Ask Question
              </button>
            </div>
          </div>

          <!-- Right: Investigation Terminal -->
          <div class="w-2/3 flex flex-col">
            <div class="px-4 py-2 border-b border-spellbook-border flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span id="investigation-title" class="text-sm font-semibold text-spellbook-muted">Select or start an investigation</span>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="closeInvestigation()" id="close-investigation-btn" class="px-2 py-1 text-xs bg-red-500/20 text-red-400 rounded hover:bg-red-500/30 hidden">
                  Close
                </button>
                <span id="investigation-status" class="text-xs text-spellbook-muted">No active investigation</span>
              </div>
            </div>
            <div id="investigation-terminal" class="flex-1 bg-[#0a0a0f]">
              <div class="flex items-center justify-center h-full text-spellbook-muted">
                <div class="text-center">
                  <div class="text-4xl mb-4">üîç</div>
                  <div class="text-lg mb-2">Start an Investigation</div>
                  <div class="text-sm text-spellbook-muted">Click "Codebase Research" or "Bug Hunt" to begin</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- INBOX VIEW -->
      <div id="inbox-view" class="flex-1 flex-col overflow-hidden hidden">
        <!-- Inbox Header -->
        <div class="px-6 py-4 border-b border-spellbook-border">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-xl font-bold text-yellow-400">üí° Ideas Inbox</h2>
              <div class="text-sm text-spellbook-muted mt-1">Quick-captured ideas waiting to be planned</div>
            </div>
            <div class="flex items-center gap-2">
              <button onclick="quickAddIdea()" class="px-4 py-2 bg-yellow-500/20 text-yellow-400 rounded hover:bg-yellow-500/30">
                + Add Idea
              </button>
            </div>
          </div>
        </div>

        <div class="flex-1 flex overflow-hidden">
          <!-- Left: Inbox Items List -->
          <div class="w-2/3 border-r border-spellbook-border overflow-y-auto p-4">
            <div class="flex items-center justify-between mb-4">
              <div class="flex gap-2">
                <button onclick="setInboxFilter('all')" class="inbox-filter active px-3 py-1 text-xs rounded" data-filter="all">All</button>
                <button onclick="setInboxFilter('feature')" class="inbox-filter px-3 py-1 text-xs rounded" data-filter="feature">Features</button>
                <button onclick="setInboxFilter('improvement')" class="inbox-filter px-3 py-1 text-xs rounded" data-filter="improvement">Improvements</button>
                <button onclick="setInboxFilter('bug')" class="inbox-filter px-3 py-1 text-xs rounded" data-filter="bug">Bugs</button>
              </div>
              <span id="inbox-count" class="text-xs text-spellbook-muted">0 ideas</span>
            </div>
            <div id="inbox-items-list" class="space-y-3">
              <div class="text-center text-spellbook-muted py-8">No ideas in inbox</div>
            </div>
          </div>

          <!-- Right: Selected Idea Detail + Actions -->
          <div class="w-1/3 flex flex-col">
            <div class="px-4 py-3 border-b border-spellbook-border">
              <span class="text-sm font-semibold">Idea Details</span>
            </div>
            <div id="inbox-detail-panel" class="flex-1 overflow-y-auto p-4">
              <div class="text-center text-spellbook-muted py-8">
                <div class="text-4xl mb-4">üí°</div>
                <div>Select an idea to view details</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- KANBAN VIEW (Default) -->
      <div id="kanban-view" class="flex-1">
        <!-- LEFT: Kanban Board (2/3) -->
        <div id="kanban-panel" class="border-r border-spellbook-border flex flex-col">
          <!-- Kanban Header -->
          <div class="px-4 py-2 border-b border-spellbook-border flex items-center justify-between">
            <div class="flex items-center gap-4">
              <span class="text-sm font-semibold">Kanban Board</span>
              <!-- Type Filter -->
              <div class="flex gap-1">
                <button onclick="setKanbanFilter('all')" class="kanban-filter active" data-filter="all">All</button>
                <button onclick="setKanbanFilter('bug')" class="kanban-filter" data-filter="bug">Bugs</button>
                <button onclick="setKanbanFilter('improvement')" class="kanban-filter" data-filter="improvement">Improvements</button>
                <button onclick="setKanbanFilter('feature')" class="kanban-filter" data-filter="feature">Features</button>
              </div>
              <!-- Priority Filter -->
              <select id="priority-filter" onchange="setKanbanPriorityFilter(this.value)" class="bg-spellbook-card border border-spellbook-border rounded px-2 py-1 text-xs">
                <option value="all">All Priorities</option>
                <option value="high">High Only</option>
                <option value="medium">Medium Only</option>
                <option value="low">Low Only</option>
              </select>
              <!-- Sort -->
              <select id="kanban-sort" onchange="setKanbanSort(this.value)" class="bg-spellbook-card border border-spellbook-border rounded px-2 py-1 text-xs">
                <option value="priority">By Priority</option>
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="number">By Number</option>
              </select>
              <!-- Search -->
              <div class="flex items-center gap-1">
                <input type="text"
                       id="kanban-search"
                       placeholder="Search bugs, improvements..."
                       class="px-3 py-1 bg-spellbook-card border border-spellbook-border rounded text-xs focus:border-spellbook-accent focus:outline-none w-48"
                       oninput="handleKanbanSearch(this.value)">
                <button onclick="clearKanbanSearch()" class="text-spellbook-muted hover:text-white text-sm px-1" title="Clear search">√ó</button>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span id="kanban-count" class="text-xs text-spellbook-muted"></span>
              <button onclick="refreshKanban()" class="px-3 py-1 bg-spellbook-card border border-spellbook-border rounded text-sm hover:border-spellbook-accent" title="Refresh board">
                ‚Üª Refresh
              </button>
            </div>
          </div>

          <!-- Kanban Columns -->
          <div class="flex-1 flex gap-2 p-3 overflow-x-auto min-h-0">
            <!-- BACKLOG Column -->
            <div class="kanban-column flex-1 min-w-[180px]">
              <div class="kanban-column-header">
                <span>BACKLOG</span>
                <span id="backlog-count" class="kanban-count">0</span>
              </div>
              <div id="backlog-items" class="kanban-items" data-status="active,spec_draft"></div>
            </div>

            <!-- PLANNING Column -->
            <div class="kanban-column flex-1 min-w-[180px]">
              <div class="kanban-column-header">
                <span>PLANNING</span>
                <span id="planning-count" class="kanban-count">0</span>
              </div>
              <div id="planning-items" class="kanban-items" data-status="planning,spec_ready"></div>
            </div>

            <!-- IN PROGRESS Column -->
            <div class="kanban-column flex-1 min-w-[180px]">
              <div class="kanban-column-header">
                <span>IN PROGRESS</span>
                <span id="progress-count" class="kanban-count">0</span>
              </div>
              <div id="progress-items" class="kanban-items" data-status="in_progress"></div>
            </div>

            <!-- DONE Column -->
            <div class="kanban-column flex-1 min-w-[180px]">
              <div class="kanban-column-header">
                <span>DONE</span>
                <span id="done-count" class="kanban-count">0</span>
              </div>
              <div id="done-items" class="kanban-items" data-status="resolved,completed,complete"></div>
            </div>
          </div>

        </div>

        <!-- RIGHT: Quick Chat + Recent Activity (1/3) -->
        <div id="quick-chat-panel" class="flex flex-col">
          <div class="px-3 py-2 border-b border-spellbook-border">
            <span class="text-sm font-semibold">Quick Chat</span>
          </div>
          <div id="quick-chat-terminal" class="flex-1 bg-[#0a0a0f]"></div>

          <!-- Recent Activity -->
          <div class="border-t border-spellbook-border flex flex-col" style="height: 280px;">
            <div class="px-3 py-2 flex items-center justify-between bg-spellbook-card border-b border-spellbook-border">
              <span class="text-xs font-semibold text-spellbook-muted">RECENT ACTIVITY</span>
              <span id="activity-count" class="text-xs text-spellbook-muted"></span>
            </div>
            <div id="recent-activity-list" class="flex-1 overflow-y-auto">
              <div class="text-xs text-spellbook-muted p-2">Loading activity...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- TERMINAL MANAGER VIEW (Hidden by default) -->
      <div id="terminal-manager-view" class="flex-1 flex-col overflow-hidden hidden">
        <!-- iTerm Sessions -->
        <div class="p-4 border-b border-spellbook-border">
          <div class="flex items-center justify-between mb-3">
            <span class="text-sm font-semibold">Active iTerm Sessions</span>
            <div class="flex items-center gap-2">
              <button onclick="refreshItermSessions()" class="text-xs text-spellbook-muted hover:text-spellbook-accent">
                ‚Üª Refresh
              </button>
            </div>
          </div>
          <div id="sessions-grid" class="grid grid-cols-4 gap-3">
            <!-- Session cards rendered here -->
            <div class="text-center text-spellbook-muted py-8 col-span-4">
              No active iTerm sessions detected. Click "Work on this" on an item to start.
            </div>
          </div>
        </div>

        <!-- Document Viewer for Selected Session -->
        <div class="flex-1 flex flex-col overflow-hidden">
          <div class="px-4 py-2 border-b border-spellbook-border flex items-center gap-4">
            <span id="tm-selected-item" class="text-sm text-spellbook-muted">Select a session to view document</span>
            <div id="tm-doc-tabs" class="flex gap-2 hidden">
              <button onclick="setTMDocTab('document')" class="tm-doc-tab active px-2 py-1 text-xs rounded" data-tab="document">Document</button>
              <button onclick="setTMDocTab('changelog')" class="tm-doc-tab px-2 py-1 text-xs rounded" data-tab="changelog">Changelog</button>
            </div>
          </div>
          <div id="tm-document-viewer" class="flex-1 overflow-auto p-4">
            <div class="text-center text-spellbook-muted py-8">
              Select a session above to view its documentation.
            </div>
          </div>
        </div>
      </div>

      <!-- KNOWLEDGE BASE VIEW -->
      <div id="knowledge-view" class="flex-1 flex-col overflow-hidden hidden">
        <!-- Knowledge Base Header -->
        <div class="px-6 py-4 border-b border-spellbook-border">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-xl font-bold text-spellbook-accent">Knowledge Base</h2>
              <div id="kb-root-path" class="text-sm text-spellbook-muted mt-1">~/.spellbook/projects/{project}/knowledge</div>
            </div>
            <div class="flex items-center gap-2">
              <button onclick="createKBDoc()" class="px-3 py-1 bg-spellbook-accent/20 text-spellbook-accent rounded text-sm hover:bg-spellbook-accent/30">
                + New Doc
              </button>
              <button onclick="refreshKnowledgeBase()" class="px-3 py-1 bg-spellbook-card border border-spellbook-border rounded text-sm hover:border-spellbook-accent">
                Refresh
              </button>
            </div>
          </div>
        </div>

        <div class="flex-1 flex overflow-hidden">
          <!-- Left: File Tree (30%) -->
          <div class="w-[30%] border-r border-spellbook-border flex flex-col overflow-hidden shrink-0">
            <!-- Search -->
            <div class="p-3 border-b border-spellbook-border">
              <input type="text" id="kb-search" onkeyup="filterKBTree()" class="w-full bg-spellbook-card border border-spellbook-border rounded px-3 py-2 text-sm focus:border-spellbook-accent outline-none" placeholder="Search files...">
            </div>

            <!-- File Tree -->
            <div id="kb-file-tree" class="flex-1 overflow-y-auto p-2">
              <div class="text-center text-spellbook-muted py-8 text-sm">
                Loading file tree...
              </div>
            </div>

            <!-- Stats Footer -->
            <div class="p-3 border-t border-spellbook-border bg-spellbook-card/50">
              <div class="flex justify-between text-xs">
                <span class="text-spellbook-muted">Docs: <span id="kb-stat-total" class="text-spellbook-text">0</span></span>
                <span class="text-spellbook-muted">Folders: <span id="kb-stat-categories" class="text-spellbook-text">0</span></span>
              </div>
            </div>
          </div>

          <!-- Right: Document Viewer/Editor (70%) -->
          <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Document Header -->
            <div class="px-4 py-3 border-b border-spellbook-border flex items-center justify-between">
              <div class="flex items-center gap-3 min-w-0">
                <span id="kb-doc-title" class="text-sm font-semibold text-spellbook-muted truncate">Select a document</span>
                <span id="kb-doc-path" class="text-xs text-spellbook-muted/70 font-mono truncate hidden"></span>
              </div>
              <div id="kb-doc-actions" class="flex items-center gap-2 hidden">
                <button onclick="toggleKBEditMode()" id="kb-edit-toggle" class="px-3 py-1 text-xs bg-spellbook-card border border-spellbook-border rounded hover:border-spellbook-accent">
                  Edit
                </button>
                <button onclick="saveKBDoc()" id="kb-save-btn" class="hidden px-3 py-1 text-xs bg-spellbook-accent text-spellbook-bg rounded hover:bg-spellbook-accent/80">
                  Save
                </button>
                <button onclick="openKBInClaude()" id="kb-claude-btn" class="px-3 py-1 text-xs bg-purple-500/20 text-purple-400 rounded hover:bg-purple-500/30" title="Open Claude session in knowledge directory">
                  Claude
                </button>
              </div>
            </div>

            <!-- Document Content (View Mode) -->
            <div id="kb-doc-view" class="flex-1 overflow-auto p-6 prose prose-invert max-w-none">
              <div class="text-center text-spellbook-muted py-16">
                <div class="text-4xl mb-4">üìö</div>
                <div class="text-lg mb-2">Knowledge Base</div>
                <div class="text-sm">Select a document from the file tree to view its contents</div>
              </div>
            </div>

            <!-- Document Editor (Edit Mode - hidden by default) -->
            <div id="kb-doc-edit" class="flex-1 flex-col overflow-hidden hidden">
              <textarea id="kb-editor" class="flex-1 w-full bg-spellbook-bg border-0 p-6 text-sm font-mono text-spellbook-text resize-none focus:outline-none" placeholder="Enter markdown content..."></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- WORKTREES VIEW -->
      <div id="worktrees-view" class="flex-1 flex overflow-hidden hidden">
        <!-- Left: Worktrees List (60%) -->
        <div class="w-[60%] flex flex-col border-r border-spellbook-border">
          <!-- Worktrees Header -->
          <div class="px-6 py-4 border-b border-spellbook-border">
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-xl font-bold text-spellbook-accent">Worktrees</h2>
                <div id="worktrees-project-path" class="text-sm text-spellbook-muted mt-1">Parallel development branches</div>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="refreshWorktreesView()" class="px-3 py-1 bg-spellbook-card border border-spellbook-border rounded text-sm hover:border-spellbook-accent">
                  Refresh
                </button>
              </div>
            </div>
          </div>

          <!-- Worktrees Content -->
          <div class="flex-1 overflow-auto p-6">
            <!-- Stats Row -->
            <div class="grid grid-cols-4 gap-4 mb-6">
              <div class="bg-spellbook-card border border-spellbook-border rounded-lg p-4">
                <div id="wt-stat-total" class="text-2xl font-bold text-spellbook-accent">0</div>
                <div class="text-xs text-spellbook-muted">Total Worktrees</div>
              </div>
              <div class="bg-spellbook-card border border-spellbook-border rounded-lg p-4">
                <div id="wt-stat-active" class="text-2xl font-bold text-green-400">0</div>
                <div class="text-xs text-spellbook-muted">Active</div>
              </div>
              <div class="bg-spellbook-card border border-spellbook-border rounded-lg p-4">
                <div id="wt-stat-assigned" class="text-2xl font-bold text-blue-400">0</div>
                <div class="text-xs text-spellbook-muted">Assigned to Items</div>
              </div>
              <div class="bg-spellbook-card border border-spellbook-border rounded-lg p-4">
                <div id="wt-stat-main" class="text-2xl font-bold text-purple-400">1</div>
                <div class="text-xs text-spellbook-muted">Main Repo</div>
              </div>
            </div>

            <!-- Worktrees List -->
            <div class="mb-4 flex items-center justify-between">
              <h3 class="text-sm font-semibold text-spellbook-muted">ACTIVE WORKTREES</h3>
              <span id="worktrees-count" class="text-xs text-spellbook-muted">0 worktrees</span>
            </div>
            <div id="worktrees-list" class="space-y-3">
              <div class="text-center text-spellbook-muted py-8">Loading worktrees...</div>
            </div>
          </div>
        </div>

        <!-- Right: Worktree Terminal (40%) -->
        <div class="w-[40%] flex flex-col">
          <div class="px-3 py-2 border-b border-spellbook-border flex items-center justify-between">
            <span class="text-sm font-semibold">Worktree Terminal</span>
            <span id="worktree-terminal-status" class="text-xs text-gray-400">Not connected</span>
          </div>
          <div id="worktree-terminal" class="flex-1 min-h-0 bg-[#0a0a0f]"></div>
        </div>
      </div>

    </main>

    </div> <!-- End of MAIN CONTENT WRAPPER -->

  </div> <!-- End of #app -->

  <!-- Toast Notification Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2 max-w-md"></div>

  <!-- UNIFIED BOTTOM BAR - Single bar with sessions, stats, and worktrees -->
  <footer id="bottom-bar" class="fixed bottom-0 left-0 right-0 border-t border-spellbook-border pl-[72px] pr-3 py-1.5 flex items-center gap-4 text-xs bg-spellbook-card z-40">
    <!-- Sessions -->
    <div class="flex items-center gap-2">
      <span class="text-spellbook-muted">SESSIONS:</span>
      <div id="session-pills" class="flex gap-1">
        <span class="text-spellbook-muted">No active sessions</span>
      </div>
    </div>

    <div class="flex-1"></div>

    <!-- Stats -->
    <span id="stats-summary" class="text-spellbook-muted"></span>

    <!-- Worktrees -->
    <button onclick="toggleWorktrees()" class="text-spellbook-muted hover:text-spellbook-accent flex items-center gap-1">
      WORKTREES <span id="worktree-toggle">‚ñº</span>
    </button>
  </footer>

  <!-- Worktrees Dropdown - Fixed position above bottom bar -->
  <div id="worktree-dropdown" class="hidden fixed bottom-10 right-4 bg-spellbook-card border border-spellbook-border rounded-lg shadow-xl p-3 min-w-[300px] max-h-[200px] overflow-auto z-50">
    <div class="text-xs font-semibold text-spellbook-muted mb-2">Active Worktrees</div>
    <div id="worktree-list" class="space-y-1"></div>
  </div>

  <!-- PLANNING VIEW OVERLAY (Fullscreen when open) -->
  <div id="planning-view" class="fixed inset-0 bg-spellbook-bg z-50 flex flex-col hidden">
    <!-- Planning View Header -->
    <div class="border-b border-spellbook-border px-4 py-2 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <button onclick="minimizePlanningView()" class="px-3 py-1 bg-spellbook-card border border-spellbook-border rounded text-sm hover:border-spellbook-accent">
          ‚Üê Minimize
        </button>
        <span id="planning-item-ref" class="text-spellbook-accent font-semibold">improvement-32</span>
        <span id="planning-item-title" class="text-sm truncate max-w-md">Auto-Finalize Tracking for Depleted Pools</span>
      </div>
      <div class="flex items-center gap-2">
        <span id="planning-status-badge" class="px-2 py-1 text-xs rounded bg-blue-500/20 text-blue-400">Planning</span>
        <!-- Worktree indicator -->
        <div id="worktree-indicator" class="flex items-center gap-2 px-2 py-1 bg-spellbook-card border border-spellbook-border rounded text-xs">
          <span id="worktree-icon" class="text-spellbook-muted">üå≤</span>
          <span id="worktree-info" class="text-spellbook-muted">No worktree</span>
          <button id="worktree-action-btn" onclick="handleWorktreeAction()" class="px-2 py-0.5 bg-spellbook-accent/20 text-spellbook-accent rounded hover:bg-spellbook-accent/30 text-xs">
            Create
          </button>
        </div>
        <button id="close-planning-btn" class="px-3 py-1 text-spellbook-muted hover:text-white relative z-[100]">
          ‚úï Close
        </button>
      </div>
    </div>

    <!-- Planning View Content - Full Width Documentation -->
    <div class="flex-1 flex overflow-hidden" id="planning-split-container">
      <!-- Document Viewer (Full Width - No Terminal) -->
      <div class="flex-1 flex flex-col" id="planning-doc-panel">
        <div class="px-3 py-2 border-b border-spellbook-border flex items-center justify-between shrink-0">
          <div class="flex gap-2">
            <button onclick="setPlanningDocTab('document')" class="planning-doc-tab active px-3 py-1 text-sm rounded" data-tab="document">Document</button>
            <button onclick="setPlanningDocTab('plan')" class="planning-doc-tab px-3 py-1 text-sm rounded" data-tab="plan">Plan</button>
            <button onclick="setPlanningDocTab('changelog')" class="planning-doc-tab px-3 py-1 text-sm rounded" data-tab="changelog">Changelog</button>
            <button onclick="setPlanningDocTab('files')" class="planning-doc-tab px-3 py-1 text-sm rounded" data-tab="files">
              Files <span id="files-count" class="text-xs text-spellbook-muted ml-1"></span>
            </button>
          </div>
          <div class="flex items-center gap-3">
            <span id="plan-status-indicator" class="text-xs"></span>
            <span id="doc-refresh-indicator" class="text-xs text-spellbook-muted">‚Üª Auto-refreshes</span>
            <span id="doc-last-modified" class="text-xs text-spellbook-muted"></span>
            <!-- Open in iTerm Button -->
            <button id="open-iterm-btn" onclick="openInIterm()" class="px-3 py-1 text-sm bg-spellbook-accent/20 text-spellbook-accent rounded hover:bg-spellbook-accent/30 flex items-center gap-2">
              <span>‚åò</span> Open in iTerm
            </button>
          </div>
        </div>
        <div id="planning-document-content" class="flex-1 overflow-auto p-4 prose prose-invert max-w-none min-h-0">
          Loading document...
        </div>
      </div>
    </div>

    <!-- Planning View Action Bar -->
    <div class="border-t border-spellbook-border px-4 py-2 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <span class="text-xs text-spellbook-muted">Working on: <span id="planning-working-ref" class="text-spellbook-accent">improvement-32</span></span>
        <span id="workflow-phase-badge" class="px-2 py-0.5 text-xs rounded bg-blue-500/20 text-blue-400">planning</span>
        <!-- Workflow Progress Indicator -->
        <div id="workflow-progress" class="flex items-center gap-1 text-xs">
          <span id="wf-step-plan" class="workflow-step px-2 py-0.5 rounded bg-gray-500/20 text-gray-400">Plan</span>
          <span class="text-spellbook-muted">‚Üí</span>
          <span id="wf-step-impl" class="workflow-step px-2 py-0.5 rounded bg-gray-500/20 text-gray-400">Implement</span>
          <span class="text-spellbook-muted">‚Üí</span>
          <span id="wf-step-commit" class="workflow-step px-2 py-0.5 rounded bg-gray-500/20 text-gray-400">Commit</span>
          <span class="text-spellbook-muted">‚Üí</span>
          <span id="wf-step-pr" class="workflow-step px-2 py-0.5 rounded bg-gray-500/20 text-gray-400">PR</span>
          <span class="text-spellbook-muted">‚Üí</span>
          <span id="wf-step-review" class="workflow-step px-2 py-0.5 rounded bg-gray-500/20 text-gray-400">Review</span>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <!-- Workflow buttons - shown contextually based on status -->
        <button id="create-pr-btn" onclick="createPullRequest()" class="hidden px-4 py-2 bg-purple-500 text-white rounded font-semibold hover:bg-purple-600">
          Create PR ‚Üí
        </button>
        <button id="code-rabbit-btn" onclick="startCodeRabbitReview()" class="hidden px-4 py-2 bg-orange-500 text-white rounded font-semibold hover:bg-orange-600">
          CodeRabbit Review ‚Üí
        </button>
        <button id="finalize-item-btn" onclick="finalizeItem()" class="hidden px-4 py-2 bg-green-500 text-white rounded font-semibold hover:bg-green-600">
          Mark Complete ‚úì
        </button>
        <!-- Subtle fallback if Claude doesn't auto-implement -->
        <button id="manual-implement-btn" onclick="triggerImplementSkill()" class="hidden px-3 py-1 text-xs text-spellbook-muted hover:text-spellbook-accent border border-spellbook-border rounded" title="Use if Claude didn't auto-start after plan approval">
          ‚Üª Retry /implement
        </button>
      </div>
    </div>
  </div>

  <!-- Item Detail Modal -->
  <div id="item-detail-modal" class="modal-overlay hidden">
    <div class="modal-content max-w-5xl max-h-[85vh] flex flex-col">
      <div class="modal-header">
        <div class="flex items-center gap-3">
          <span id="detail-ref" class="text-spellbook-accent font-bold text-lg">bug-44</span>
          <span id="detail-status-badge" class="px-2 py-1 text-xs rounded bg-gray-500/20 text-gray-400">active</span>
          <span id="detail-priority-badge" class="px-2 py-1 text-xs rounded">medium</span>
        </div>
        <button onclick="hideItemDetailModal()" class="text-spellbook-muted hover:text-white text-2xl">&times;</button>
      </div>
      <div class="modal-body flex-1 flex flex-col overflow-hidden">
        <h2 id="detail-title" class="text-xl font-semibold mb-3">Item Title</h2>

        <!-- Metadata Row -->
        <div class="flex flex-wrap gap-6 mb-4 text-sm border-b border-spellbook-border pb-4">
          <div>
            <span class="text-spellbook-muted">Created:</span>
            <span id="detail-created" class="ml-2">-</span>
          </div>
          <div>
            <span class="text-spellbook-muted">Updated:</span>
            <span id="detail-updated" class="ml-2">-</span>
          </div>
          <div id="detail-feature-row" class="hidden">
            <span class="text-spellbook-muted">Linked Feature:</span>
            <span id="detail-feature" class="ml-2 text-purple-400">-</span>
          </div>
          <div id="detail-owner-row" class="hidden">
            <span class="text-spellbook-muted">Owner:</span>
            <span id="detail-owner" class="ml-2 text-blue-400">-</span>
          </div>
          <div id="detail-docpath-row">
            <span class="text-spellbook-muted">Doc:</span>
            <span id="detail-docpath" class="ml-2 text-xs font-mono text-spellbook-muted">-</span>
          </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-3">
          <button onclick="setDetailTab('document')" class="detail-tab active px-4 py-2 text-sm rounded" data-tab="document">
            üìÑ Document
          </button>
          <button onclick="setDetailTab('changelog')" class="detail-tab px-4 py-2 text-sm rounded" data-tab="changelog">
            üìù Changelog
          </button>
          <button onclick="setDetailTab('files')" class="detail-tab px-4 py-2 text-sm rounded" data-tab="files">
            üìÅ Files Changed
          </button>
        </div>

        <!-- Tab Content -->
        <div id="detail-tab-content" class="flex-1 min-h-0 overflow-hidden">
          <!-- Document Tab -->
          <div id="detail-document-tab" class="h-full">
            <div id="detail-doc-content" class="bg-spellbook-bg border border-spellbook-border rounded p-4 prose prose-invert max-w-none h-full max-h-[50vh] overflow-y-auto">
              Loading...
            </div>
          </div>
          <!-- Changelog Tab -->
          <div id="detail-changelog-tab" class="h-full hidden">
            <div id="detail-changelog-content" class="bg-spellbook-bg border border-spellbook-border rounded p-4 prose prose-invert max-w-none h-full max-h-[50vh] overflow-y-auto">
              Loading...
            </div>
          </div>
          <!-- Files Tab -->
          <div id="detail-files-tab" class="h-full hidden">
            <div id="detail-files-content" class="bg-spellbook-bg border border-spellbook-border rounded p-4 h-full max-h-[50vh] overflow-y-auto">
              <div class="text-spellbook-muted">No files changed listed</div>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-between items-center pt-4 border-t border-spellbook-border mt-4">
          <div class="flex gap-2">
            <button onclick="openDocInEditor()" class="px-3 py-2 text-sm bg-spellbook-card border border-spellbook-border rounded hover:border-spellbook-accent">
              üìÑ Open in Editor
            </button>
            <button id="detail-finalize-btn" onclick="quickFinalize()" class="px-3 py-2 text-sm bg-green-500/20 text-green-400 rounded hover:bg-green-500/30 hidden">
              ‚úì Mark Complete
            </button>
          </div>
          <div class="flex gap-2">
            <button onclick="hideItemDetailModal()" class="px-4 py-2 text-spellbook-muted hover:text-white">
              Close
            </button>
            <button onclick="openPlanningFromModal()" class="px-4 py-2 bg-spellbook-accent text-black rounded font-semibold">
              üîß Work on This
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Work Mode Selection Modal -->
  <div id="work-mode-modal" class="modal-overlay hidden">
    <div class="modal-content max-w-md">
      <div class="modal-header">
        <div>
          <h3 class="font-bold text-lg">Start Working</h3>
          <div id="work-mode-item-ref" class="text-sm text-spellbook-accent font-mono mt-1">improvement-33</div>
        </div>
        <button onclick="hideWorkModeModal()" class="text-spellbook-muted hover:text-white text-2xl">&times;</button>
      </div>
      <div class="modal-body">
        <div class="space-y-4">
          <!-- Work Mode Options -->
          <div class="space-y-3">
            <label class="flex items-start gap-3 p-3 bg-spellbook-card border border-spellbook-border rounded-lg cursor-pointer hover:border-spellbook-accent transition-colors">
              <input type="radio" name="work-mode" value="develop" class="mt-1" checked>
              <div>
                <div class="font-semibold text-sm">Work on develop branch</div>
                <div class="text-xs text-spellbook-muted mt-1">Open terminal in main project directory. Best for quick fixes or when you want to manage branches yourself.</div>
              </div>
            </label>
            <label class="flex items-start gap-3 p-3 bg-spellbook-card border border-spellbook-border rounded-lg cursor-pointer hover:border-spellbook-accent transition-colors">
              <input type="radio" name="work-mode" value="worktree" class="mt-1">
              <div>
                <div class="font-semibold text-sm">Create new worktree</div>
                <div class="text-xs text-spellbook-muted mt-1">Create an isolated worktree with its own branch. Best for parallel work or keeping changes separate.</div>
              </div>
            </label>
          </div>

          <!-- Worktree Options (shown when worktree mode selected) -->
          <div id="worktree-options" class="hidden space-y-3 pt-3 border-t border-spellbook-border">
            <div>
              <label class="block text-sm text-spellbook-muted mb-1">Branch Name</label>
              <input type="text" id="worktree-branch-name" class="w-full bg-spellbook-card border border-spellbook-border rounded px-3 py-2 text-sm font-mono focus:border-spellbook-accent outline-none" placeholder="improvement/33-auto-finalize">
            </div>
            <div class="text-xs text-spellbook-muted">
              Worktree will be created at: <span id="worktree-path-preview" class="font-mono text-spellbook-text">~/.worktrees/project/branch</span>
            </div>
            <div class="flex flex-col gap-2 mt-3">
              <label class="flex items-center gap-2 text-sm cursor-pointer">
                <input type="checkbox" id="worktree-install-deps" class="rounded border-spellbook-border" checked>
                <span>Install dependencies</span>
              </label>
            </div>
            <div class="text-xs text-spellbook-muted mt-2 p-2 bg-spellbook-card/50 rounded">
              <strong>Full setup:</strong> Creates worktree, copies .env files, symlinks docs/knowledge, allocates ports, installs deps, and launches Claude agent.
            </div>
          </div>
        </div>

        <div class="mt-6 pt-4 border-t border-spellbook-border flex justify-end gap-2">
          <button onclick="hideWorkModeModal()" class="px-4 py-2 text-spellbook-muted hover:text-white">
            Cancel
          </button>
          <button onclick="submitWorkMode()" class="px-4 py-2 bg-spellbook-accent text-black rounded font-semibold hover:bg-spellbook-accent/80">
            Start Working
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Worktree Progress Modal -->
  <div id="worktree-progress-modal" class="modal-overlay hidden">
    <div class="modal-content max-w-md">
      <div class="modal-header">
        <div>
          <h3 class="font-bold text-lg">Creating Worktree</h3>
          <div id="progress-item-ref" class="text-sm text-spellbook-accent font-mono mt-1">bug-44</div>
        </div>
      </div>
      <div class="modal-body">
        <!-- Progress Steps -->
        <div id="progress-steps" class="space-y-3">
          <div class="progress-step" data-step="create">
            <div class="flex items-center gap-3">
              <div class="progress-icon w-6 h-6 rounded-full bg-spellbook-card border border-spellbook-border flex items-center justify-center text-xs">
                <span class="step-pending">‚óã</span>
                <span class="step-active hidden">
                  <svg class="animate-spin h-4 w-4 text-spellbook-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </span>
                <span class="step-done hidden text-green-400">‚úì</span>
                <span class="step-error hidden text-red-400">‚úó</span>
              </div>
              <div class="flex-1">
                <div class="text-sm font-medium">Creating worktree</div>
                <div class="text-xs text-spellbook-muted step-status">Waiting...</div>
              </div>
            </div>
          </div>

          <div class="progress-step" data-step="checkout">
            <div class="flex items-center gap-3">
              <div class="progress-icon w-6 h-6 rounded-full bg-spellbook-card border border-spellbook-border flex items-center justify-center text-xs">
                <span class="step-pending">‚óã</span>
                <span class="step-active hidden">
                  <svg class="animate-spin h-4 w-4 text-spellbook-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </span>
                <span class="step-done hidden text-green-400">‚úì</span>
                <span class="step-error hidden text-red-400">‚úó</span>
              </div>
              <div class="flex-1">
                <div class="text-sm font-medium">Checking out branch</div>
                <div class="text-xs text-spellbook-muted step-status">Waiting...</div>
              </div>
            </div>
          </div>

          <div class="progress-step" data-step="setup">
            <div class="flex items-center gap-3">
              <div class="progress-icon w-6 h-6 rounded-full bg-spellbook-card border border-spellbook-border flex items-center justify-center text-xs">
                <span class="step-pending">‚óã</span>
                <span class="step-active hidden">
                  <svg class="animate-spin h-4 w-4 text-spellbook-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </span>
                <span class="step-done hidden text-green-400">‚úì</span>
                <span class="step-error hidden text-red-400">‚úó</span>
              </div>
              <div class="flex-1">
                <div class="text-sm font-medium">Setting up environment</div>
                <div class="text-xs text-spellbook-muted step-status">Waiting...</div>
              </div>
            </div>
          </div>

          <div class="progress-step" data-step="deps">
            <div class="flex items-center gap-3">
              <div class="progress-icon w-6 h-6 rounded-full bg-spellbook-card border border-spellbook-border flex items-center justify-center text-xs">
                <span class="step-pending">‚óã</span>
                <span class="step-active hidden">
                  <svg class="animate-spin h-4 w-4 text-spellbook-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </span>
                <span class="step-done hidden text-green-400">‚úì</span>
                <span class="step-error hidden text-red-400">‚úó</span>
              </div>
              <div class="flex-1">
                <div class="text-sm font-medium">Installing dependencies</div>
                <div class="text-xs text-spellbook-muted step-status">Waiting...</div>
              </div>
            </div>
          </div>

          <div class="progress-step" data-step="ready">
            <div class="flex items-center gap-3">
              <div class="progress-icon w-6 h-6 rounded-full bg-spellbook-card border border-spellbook-border flex items-center justify-center text-xs">
                <span class="step-pending">‚óã</span>
                <span class="step-active hidden">
                  <svg class="animate-spin h-4 w-4 text-spellbook-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </span>
                <span class="step-done hidden text-green-400">‚úì</span>
                <span class="step-error hidden text-red-400">‚úó</span>
              </div>
              <div class="flex-1">
                <div class="text-sm font-medium">Ready to work</div>
                <div class="text-xs text-spellbook-muted step-status">Waiting...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Result Summary (shown after completion) -->
        <div id="progress-result" class="hidden mt-4 p-3 rounded-lg">
          <div id="progress-result-content"></div>
        </div>

        <!-- Error Message -->
        <div id="progress-error" class="hidden mt-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
          <div class="text-sm text-red-400" id="progress-error-message"></div>
        </div>

        <!-- Actions -->
        <div class="mt-6 pt-4 border-t border-spellbook-border flex justify-end gap-2">
          <button id="progress-cancel-btn" onclick="cancelWorktreeProgress()" class="px-4 py-2 text-spellbook-muted hover:text-white">
            Cancel
          </button>
          <button id="progress-continue-btn" onclick="continueFromProgress()" class="px-4 py-2 bg-spellbook-accent text-black rounded font-semibold hidden">
            Open Planning View
          </button>
          <button id="progress-retry-btn" onclick="retryWorktreeCreation()" class="px-4 py-2 bg-red-500/20 text-red-400 rounded font-semibold hidden">
            Retry
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Log Modal -->
  <div id="quick-log-modal" class="modal-overlay hidden">
    <div class="modal-content max-w-lg">
      <div class="modal-header">
        <h3 id="quick-log-title" class="font-bold text-lg">Log Bug</h3>
        <button onclick="hideQuickLogModal()" class="text-spellbook-muted hover:text-white text-2xl">&times;</button>
      </div>
      <div class="modal-body">
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-spellbook-muted mb-1">Title</label>
            <input type="text" id="quick-log-input" class="w-full bg-spellbook-card border border-spellbook-border rounded px-3 py-2 text-sm focus:border-spellbook-accent outline-none" placeholder="Brief description...">
          </div>
          <div>
            <label class="block text-sm text-spellbook-muted mb-1">Priority</label>
            <select id="quick-log-priority" class="bg-spellbook-card border border-spellbook-border rounded px-3 py-2 text-sm">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-spellbook-muted mb-1">Description (optional)</label>
            <textarea id="quick-log-description" class="w-full bg-spellbook-card border border-spellbook-border rounded px-3 py-2 text-sm h-24 resize-none focus:border-spellbook-accent outline-none" placeholder="Additional details..."></textarea>
          </div>
        </div>
        <div class="mt-4 pt-4 border-t border-spellbook-border flex justify-end gap-2">
          <button onclick="hideQuickLogModal()" class="px-4 py-2 text-spellbook-muted hover:text-white">
            Cancel
          </button>
          <button onclick="submitQuickLog()" class="px-4 py-2 bg-spellbook-accent text-black rounded font-semibold">
            Create
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
